<section class="loan-calculator loan-calculator--has-bg pt-25" id="SeccionCotizador">


    <div class="container">
        <div class="loan-calculator__top">
            <div class="row">
                <div class="col-md-12">
                    <div class="block-title text-left">
                        <h3 class="block-title__title text-center">Simula tu prestamo</h3><!-- /.block-title__tagline -->
                    </div><!-- /.block-title -->
                </div><!-- /.col-md-6 -->

                <div class="col-md-12">

                    <!-- Steps -->
                    <div class="example">
                        <div class="pearls row" style="margin: 0 0 1px;">
                            <div class="pearl current active col-4">
                                <div class="pearl-icon"><i class="fa fa-car" aria-hidden="true"></i></div>
                                <span class="pearl-title">TU AUTO</span>
                            </div>
                            <div class="pearl col-4">
                                <div class="pearl-icon"><i class="icon md-pin-account" aria-hidden="true"></i></div>
                                <span class="pearl-title">TUS DATOS</span>
                            </div>
                            <div class="pearl col-4">
                                <div class="pearl-icon"><i class="icon md-check" aria-hidden="true"></i></div>
                                <span class="pearl-title">VALIDACIÓN</span>
                            </div>
                        </div>
                    </div>
                    <!-- End Steps -->

                </div>

            </div><!-- /.row -->
        </div><!-- /.loan-calculator__top -->

        <div class="loan-calculator__box">
            <div class="row row-gutter-x-0">
                <div class="col-lg-6">
                    <form class="loan-calculator__form" action="contact.html" id="loan-calculator" data-interest-rate="15">
                        <div class="input-box__top">
                            <span>$30000</span>
                            <span>$500000</span>
                        </div><!-- /.input-box__top -->
                        <div class="input-box">
                            <div class="range-slider-count" id="range-slider-count"></div>
                            <input type="hidden" value="" id="min-value-rangeslider-count">
                            <input type="hidden" value="" id="max-value-rangeslider-count">
                        </div><!-- /.input-box -->
                        <div class="input-box__top">
                            <span>1 Month</span>
                            <span>12 Months</span>
                        </div><!-- /.input-box__top -->
                        <div class="input-box">
                            <div class="range-slider-month" id="range-slider-month"></div>
                            <input type="hidden" value="" id="min-value-rangeslider-month">
                            <input type="hidden" value="" id="max-value-rangeslider-month">
                        </div><!-- /.input-box -->
                        <p>
                            <span>Pay Monthly</span>
                            <b>$<i id="loan-monthly-pay"></i></b>
                        </p>
                        <p>
                            <span>Term of Use</span>
                            <b><i id="loan-month"></i> Months</b>
                        </p>
                        <p>
                            <span>Total Pay Back</span>
                            <b>$<i id="loan-total"></i></b>
                        </p>
                        <a href="apply-now.html" class="thm-btn thm-btn--dark-hover">Apply For Loan</a>






                        <div class="row">

                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="IdAnio" class="text-blue">Año de tu auto</label>
                                    @Html.DropDownList("IdAnio", (IEnumerable<SelectListItem>)ViewBag.IdAnio, new { @class = "form-control select2", id = "IdAnio", @dataplugin = "select2" })
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="IdMarca" class="text-blue">Marca</label>
                                    <select class="form-control select2" id="IdMarca" required="required" name="IdMarca" data-plugin="select2">
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="IdModelo" class="text-blue">Modelo</label>
                                    <select class="form-control select2" id="IdModelo" name="IdModelo" required="required" data-plugin="select2">
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="IdVersion" class="text-blue">Versión</label>
                                    <select class="form-control select2" id="IdVersion" required="required" name="IdVersion" data-plugin="select2">
                                    </select>
                                </div>
                            </div>

                        </div>







                        <div class="loan-calculator__form__terms">
                            *These calculators are provided only as general
                            self-help
                            Planning
                            Tools. Results depend on other factors.
                        </div><!-- /.loan-calculator__terms -->
                    </form><!-- /.about-one__from -->
                </div><!-- /.col-lg-6 -->
                <div class="col-lg-6">
                    <div class="loan-calculator__image">
                        <img src="~/Content/assets-crese/images/resources/loan-calculator-1-1.png" alt="">
                        <div class="loan-calculator__image__caption wow fadeInUp" data-wow-duration="1500ms">
                            <div class="loan-calculator__image__caption__inner">
                                <h3 class="loan-calculator__image__title">98<span>%</span></h3>
                                <!-- /.loan-calculator__image__title -->
                                <p class="loan-calculator__image__text">Satisfied Customers</p>
                            </div><!-- /.loan-calculator__image__caption__inner -->
                        </div><!-- /.loan-calculator__image__caption -->
                    </div><!-- /.loan-calculator__image -->
                </div><!-- /.col-lg-6 -->
            </div><!-- /.row -->
        </div><!-- /.loan-calculator__box -->
    </div><!-- /.container -->

</section>


<!-- Testimonial Section End -->
<!-- ##### Newsletter Area End ###### -->
@section Scripts {

    <script>



    var mapSimulacion = [];

    function GetMarcaSelect(IdAnio) {
        fillComboBox("IdMarca", "Cotizador", "GetMarcaSelect", { IdAnio: IdAnio }, null);
    }

    function GetModeloSelect(IdAnio, IdMarca)
    {
        fillComboBox("IdModelo", "Cotizador", "GetModeloSelect", { IdAnio: IdAnio, IdMarca: IdMarca }, null);
    }

    function GetVersionSelect(IdAnio, IdMarca, IdModelo)
    {
        fillComboBox("IdVersion", "Cotizador", "GetVersionComboBox", { IdAnio: IdAnio, IdMarca: IdMarca, IdModelo: IdModelo, Marca: $("#IdMarca option:selected").text(), Modelo: $("#IdModelo option:selected").text() }, null);

        //var url = '@Url.Action("GetVersionSelect", "Cotizador")';
        //$.get(url, { IdAnio: IdAnio, IdMarca: IdMarca, IdModelo: IdModelo, Marca: $("#IdMarca option:selected").text(), Modelo: $("#IdModelo option:selected").text() }).done(function (data) {
        //    $("#divVersiones").html(data);
        //})
    }

    $("#IdAnio").change(function () {
        var IdAnio = $("#IdAnio").val();
        GetMarcaSelect(IdAnio);
        clearComboBox("IdModelo", "Seleccionar", -1)
        clearComboBox("IdVersion", "Seleccionar", -1)
        updateSelect();
    })

    $("#IdMarca").change(function () {
        var IdAnio = $("#IdAnio").val();
        var IdMarca = $("#IdMarca").val();
        GetModeloSelect(IdAnio, IdMarca);
        clearComboBox("IdVersion", "Seleccionar", -1)

    })

    $("#IdModelo").change(function () {
        var IdAnio = $("#IdAnio").val();
        var IdMarca = $("#IdMarca").val();
        var IdModelo = $("#IdModelo").val();
        GetVersionSelect(IdAnio, IdMarca, IdModelo);

    })

    function clearComboBox(select, Label, DefaulValue) {
        $('#' + select + ' option').remove();
        $('#' + select).append('<option value="' + DefaulValue + '">' + Label + '</option>');
    }

    function CalcularSimulacion() {
        var Clave = $("#IdVesion").val();
        var Nombre = $('#IdVesion option:selected').text();
        var url = '@Url.Action("Simulacion","Page")';
        var Data = mapSimulacion[Clave];
        window.location = url + '?Clave=' + Clave + '&Nombre=' + Nombre + '&Compra=' + Data.Compra + '&Moneda=' + Data.Moneda + '&Venta=' + Data.Venta;
    }

    function fillComboBox(select, controlador, metodo, parametros, value) {
        var url = '/' + controlador + '/' + metodo
        $.ajax({
            async: true,
            cache: false,
            dataType: "html",
            type: 'GET',
            url: url,
            data: parametros,
            success: function (data) {
                var Data = JSON.parse(data)

                console.log(Data);

                $('#' + select + ' option').remove();
                if (Data.length == 0) {
                    $('#' + select).append('<option value=""-1""></option>');
                }
                else {
                    //Se agrega el elemento vacio para poder desplegar que seleccione una opcion
                    datas = Data;
                    var id_res = 0;
                    mapSimulacion = [];
                    $.each(Data, function (i, item) {
                        $('#' + select).append('<option value="' + item.Clave + '">' +
                            item.Nombre + '</option>');
                    });
                    $('#' + select).val(value);
                }

            },
            beforeSend: function () { },
            error: function (objXMLHttpRequest) { }
        });
    }

    function MostrarPrecio(Clave, version) {
        var url = '@Url.Action("GetPrecioDeCompra", "Cotizador")';
        $.get(url, { Clave: Clave, version: version}).done(function (data) {
            $("#DivPreciosTemp").html(data);
        })
        }

        var defaults = {
            step: '.steps .step, .pearls .pearl',
            templates: {
                buttons: function buttons() {
                    var options = this.options;
                    return "<div class=\"wizard-buttons container\"><a class=\"btn btn-default btn-outline\" href=\"#".concat(this.id, "\" data-wizard=\"back\" role=\"button\">").concat("Atras", "</a><a class=\"btn style1 btn-outline float-right\" href=\"#").concat(this.id, "\" data-wizard=\"next\" role=\"button\">").concat("Seguir", "</a><a class=\"btn style1 btn-outline float-right\" href=\"#").concat(this.id, "\" data-wizard=\"finish\" role=\"button\">").concat("Continuá tu solicitud", "</a></div>");
                }
            },
            classes: {
                step: {
                    active: 'active'
                },
                button: {
                    hide: 'hidden-xs-up',
                    disabled: 'disabled'
                }
            }
        };
        var options = $.extend(true, {}, defaults,
            {
                onInit: function onInit() {
                    $('#exampleFormContainer').formValidation({
                        framework: 'bootstrap',
                        fields: {
                            Nombre: {
                                validators: {
                                    notEmpty: {
                                        message: 'El nombre es requerida.'
                                    }
                                }
                            },
                            ApellidoPaterno: {
                                validators: {
                                    notEmpty: {
                                        message: 'El appelido paterno es requerida.'
                                    }
                                }
                            },
                            IdMarca: {
                                validators: {
                                    notEmpty: {
                                        message: 'La año es requerida.'
                                    }
                                }
                            },
                            IdModelo: {
                                validators: {
                                    notEmpty: {
                                        message: 'El modelo es requerido.'
                                    }
                                }
                            },
                            IdVesion: {
                                validators: {
                                    notEmpty: {
                                        message: 'La versión es requerido.'
                                    }
                                }
                            },
                            password: {
                                validators: {
                                    notEmpty: {
                                        message: 'The password is required'
                                    }
                                }
                            },
                            AvisoPrivacidad: {
                                validators: {
                                    notEmpty: {
                                        message: 'Aceptar los terminos y condiciones'
                                    }
                                }
                            },
                            number: {
                                validators: {
                                    notEmpty: {
                                        message: 'The credit card number is not valid'
                                    }
                                }
                            },
                            Codigo: {
                                validators: {
                                    notEmpty: {
                                        message: 'Ingresa el código'
                                    }
                                }
                            }
                        },
                        err: {
                            clazz: 'invalid-feedback'
                        },
                        control: {
                            // The CSS class for valid control
                            valid: 'is-valid',
                            // The CSS class for invalid control
                            invalid: 'is-invalid'
                        },
                        row: {
                            invalid: 'has-danger'
                        }
                    });
                },
                validator: function validator() {
                    var fv = $('#exampleFormContainer').data('formValidation');
                    var $this = $(this); // Validate the container

                    fv.validateContainer($this);
                    var isValidStep = fv.isValidContainer($this);

                    if (isValidStep === false || isValidStep === null) {
                        return false;
                    }

                    if ($this.attr("id") === "DivDatosContacto") {
                        $("#TelefonoInfo").val($("#Telefono").val());
                        $("#NombreInfo").val($("#Nombre").val());
                        $("#ApellidoPaternoInfo").val($("#ApellidoPaterno").val());
                        $("#ApellidoMaternoInfo").val($("#ApellidoMaterno").val());
                        GenerarCodigo();
                    };

                    return true;
                },
                onFinish: function onFinish() {// $('#exampleFormContainer').submit();
                    validarCodigo();
                },
                buttonsAppendTo: '.panel-body'
            });


        $(function () {

            $("#IdAnio").val(null);
            $("#exampleWizardFormContainer").wizard(options);
        }); // Example Wizard Pager
  // --------------------------

        var datosTemp = {};
        function GenerarCodigo() {

            var URLCODIGO = '@Url.Action("CreateSolicitud", "Cotizador")';

            var data = {
                Telefono: $("#Telefono").val(),
                Email: $("#Email").val(),
                IdAnioLA: $("#IdAnio").val(),
                IdMarcaLA: $("#IdMarca").val(),
                IdModeloLA: $("#IdModelo").val(),
                ClaveVercion: $("#IdVersion").val(),
                Compra: 0,
                Venta: 0,
                Nombre: $("#Nombre").val(),
                ApellidoPaterno: $("#ApellidoPaterno").val(),
                ApellidoMaterno: $("#ApellidoMaterno").val(),
                NombreCopleto: $("#Nombre").val() + " " + $("#ApellidoPaterno").val() + " " + $("#ApellidoMaterno").val()
            };
            console.log(data);
            $.post(URLCODIGO, data)
                .done(function (data) {
                    console.log("Algo", data);
                    datosTemp = data;
            });



        }

        $("#Codigo").keyup(function () {
            $("#validCodigo").hide();
        });

        function validarCodigo() {
             var URLCODIGO = '@Url.Action("ValidarSolicitud", "Cotizador")';
            var data = datosTemp;
            data.CodigoValidacionNumero = $("#Codigo").val();

            $.post(URLCODIGO, data)
                .done(function (data) {
                    if (data.Error) {
                        $("#validCodigo").show();
                        $("#Codigo").addClass("is-invalid");
                    } else {
                        $("#validCodigo").hide();
                        $("#loading").show();
                        window.location = '@Url.Action("Index","Simulador")' + '?telefono=' + $("#Telefono").val() + '&codigo=' + $("#Codigo").val();
                    }

            });
        }

        function updateSelect() {
            $('#IdAnio').select2({
                placeholder: 'Selecciona año',
                width: '100%'
            });
            $('#IdMarca').select2({
                placeholder: 'Selecciona marca',
                width: '100%'
            });
            $('#IdModelo').select2({
                placeholder: 'Selecciona modelo',
                width: '100%'
            });
            $('#IdVersion').select2({
                placeholder: 'Selecciona versión',
                width: '100%'
            });
        }
        updateSelect()

    </script>
}
